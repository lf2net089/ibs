<p-toast></p-toast>
<button pButton type="button" icon="pi pi-filter" (click)="toggleSidebar()" label="Toggle Sidebar"></button>
<p-table
  [value]="guiList"
  dataKey="guiNumber"
  [tableStyle]="{ 'min-width': '60rem' }"
  [expandedRowKeys]="expandedRows"
  (onRowExpand)="onRowExpand($event)"
  (onRowCollapse)="onRowCollapse($event)"
  scrollable="true"
  scrollHeight="545px"
  [paginator]="true"
  [rows]="10"
>
  <ng-template pTemplate="caption">
    <div class="flex flex-wrap justify-content-end gap-2">
      <p-button label="Expand All" icon="pi pi-plus" text (onClick)="expandAll()" />
      <p-button label="Collapse All" icon="pi pi-minus" text (onClick)="collapseAll()" />
    </div>
  </ng-template>
  <ng-template pTemplate="header">
    <tr>
      <th style="width: 5rem"></th>
      <th pSortableColumn="guiNumber">發票號碼<p-sortIcon field="guiNumber" /></th>
      <th pSortableColumn="guiDate">發票日期<p-sortIcon field="guiDate" /></th>
      <th pSortableColumn="customerId">客戶帳號<p-sortIcon field="customerId" /></th>
      <th pSortableColumn="taxId">統一編號<p-sortIcon field="taxId" /></th>
      <th pSortableColumn="serviceCenterCode">服務中心代碼<p-sortIcon field="serviceCenterCode" /></th>
      <th pSortableColumn="salesAmount">銷售額<p-sortIcon field="salesAmount" /></th>
      <th pSortableColumn="taxAmount">稅額<p-sortIcon field="taxAmount" /></th>
      <th pSortableColumn="totalAmount">總計金額<p-sortIcon field="totalAmount" /></th>
      <th pSortableColumn="source">開立來源 <p-sortIcon field="source" /></th>
      <th pSortableColumn="reportingStatus">申報狀態<p-sortIcon field="reportingStatus" /></th>
      <th pSortableColumn="taxCategory">課稅別<p-sortIcon field="taxCategory" /></th>
    </tr>
  </ng-template>
  <ng-template pTemplate="body" let-gui let-expanded="expanded">
    <tr>
      <td>
        <p-button type="button" pRipple [pRowToggler]="gui" [text]="true" [rounded]="true" [plain]="true" [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'" />
      </td>
      <td>{{ gui.guiNumber }}</td>
      <td>{{ gui.guiDate }}</td>
      <td>{{ gui.customerId }}</td>
      <td>{{ gui.taxId }}</td>
      <td>{{ gui.serviceCenterCode }}</td>
      <td>{{ gui.salesAmount | currency }}</td>
      <td>{{ gui.taxAmount | currency }}</td>
      <td>{{ gui.totalAmount | currency }}</td>
      <td>{{ gui.source }}</td>
      <td>{{ gui.reportingStatus }}</td>
      <td>{{ gui.taxCategory }}</td>
    </tr>
  </ng-template>
  <ng-template pTemplate="rowexpansion" let-gui>
    <tr>
      <td colspan="12">
        <div class="p-3">
          <p-table [value]="gui.invoices" dataKey="invoiceNumber">
            <ng-template pTemplate="header">
              <tr>
                <th pSortableColumn="invoiceNumber">帳單號碼<p-sortIcon field="invoiceNumber" /></th>
                <th pSortableColumn="invoiceDate">帳單日期<p-sortIcon field="invoiceDate" /></th>
                <th pSortableColumn="customerId">客戶帳號<p-sortIcon field="customerId" /></th>
                <th pSortableColumn="taxId">統一編號<p-sortIcon field="taxId" /></th>
                <th pSortableColumn="serviceCenterCode">服務中心代碼<p-sortIcon field="serviceCenterCode" /></th>
                <th pSortableColumn="salesAmount">銷售額<p-sortIcon field="salesAmount" /></th>
                <th pSortableColumn="taxAmount">稅額 <p-sortIcon field="taxAmount" /></th>
                <th pSortableColumn="totalAmount">總計金額<p-sortIcon field="totalAmount" /></th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-invoice>
              <tr>
                <td>{{ invoice.invoiceNumber }}</td>
                <td>{{ invoice.invoiceDate }}</td>
                <td>{{ invoice.customerId }}</td>
                <td>{{ invoice.taxId }}</td>
                <td>{{ invoice.serviceCenterCode }}</td>
                <td>{{ invoice.salesAmount | currency }}</td>
                <td>{{ invoice.taxAmount | currency }}</td>
                <td>{{ invoice.totalAmount | currency }}</td>
              </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
              <tr>
                <td colspan="8">No invoices available for this GUI.</td>
              </tr>
            </ng-template>
          </p-table>
        </div>
      </td>
    </tr>
  </ng-template>
  <ng-template pTemplate="footer">
    <tr>
      <td colspan="12" class="text-right">Total GUIs: {{ guiList.length }}</td>
    </tr>
  </ng-template>
</p-table>

<p-sidebar [(visible)]="sidebarVisible" [baseZIndex]="10000" position="right" [modal]="false" [style]="{ width: '290px' }">
  <h2>Query Criteria</h2>
  <div class="form-grid">
    <!-- AutoComplete for Customer ID -->
    <div class="form-row">
      <label for="customerId">客戶帳號</label>
      <p-autoComplete
        [(ngModel)]="selectedCustomer"
        [suggestions]="filteredCustomers"
        [dropdown]="true"
        (completeMethod)="filterCustomer($event)"
        field="name"
        inputId="customerId"
        placeholder="Enter Customer ID">
      </p-autoComplete>
    </div>

    <!-- Input for Invoice Number using p-autoComplete with autocomplete disabled -->
    <div class="form-row">
      <label for="invoiceNumber">發票號碼</label>
      <p-autoComplete
        [(ngModel)]="invoiceNumber"
        [suggestions]="filteredInvoiceNumbers"
        [dropdown]="true"
        (completeMethod)="filterInvoiceNumber($event)"
        field="name"
        inputId="invoiceNumber"
        placeholder="Enter Invoice Number">
      </p-autoComplete>
    </div>

    <!-- Datepicker for Invoice Date Range -->
    <div class="form-grid">
      <table style="width: 90%;">
        <tr>
          <td [style.width.%]="50" [style.padding-right.px]="1">
            <div class="form-row">
              <label for="invoiceDateStart">發票日期(起)</label>
              <p-calendar
                [(ngModel)]="invoiceDateStart"
                inputId="invoiceDateStart"
                dateFormat="yy-mm-dd"
                [style.width.%]="100">
              </p-calendar>
            </div>
          </td>
          <td [style.width.%]="50" [style.padding-left.px]="1">
            <div class="form-row">
              <label for="invoiceDateEnd">發票日期(迄)</label>
              <p-calendar
                [(ngModel)]="invoiceDateEnd"
                inputId="invoiceDateEnd"
                dateFormat="yy-mm-dd"
                [style.width.%]="100">
              </p-calendar>
            </div>
          </td>
        </tr>
      </table>
    </div>


    <!-- AutoComplete for Service Center -->
    <div class="form-row">
      <label for="serviceCenter">服務中心</label>
      <p-autoComplete
        [(ngModel)]="selectedServiceCenter"
        [dropdown]="true"
        [suggestions]="filteredServiceCenters"
        (completeMethod)="filterServiceCenter($event)"
        field="name"
        inputId="serviceCenter"
        placeholder="Enter Service Center">
      </p-autoComplete>
    </div>

    <!-- Input for Source using p-autoComplete with autocomplete disabled -->
    <div class="form-row">
      <label for="source">開立來源</label>
      <p-autoComplete
        [(ngModel)]="source"
        [suggestions]="filteredSources"
        [dropdown]="true"
        (completeMethod)="filterSource($event)"
        field="name"
        inputId="source"
        placeholder="Enter Source">
      </p-autoComplete>
    </div>

    <!-- Buttons -->
    <div class="form-row form-buttons" style="margin-top: 20px;">
      <table style="width: 96%;">
        <tr>
          <td style="width: 50%; padding-right: 5px;">
            <button pButton type="button" label="Submit" icon="pi pi-check" style="width: 100%;"></button>
          </td>
          <td style="width: 50%; padding-left: 5px;">
            <button pButton type="button" label="Clear" class="p-button-secondary" style="width: 100%;"></button>
          </td>
        </tr>
      </table>
    </div>

  </div>
</p-sidebar>

<!-- Button to Toggle Sidebar -->
